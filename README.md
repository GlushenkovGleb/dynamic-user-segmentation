# dynamic-user-segmentation
Сервис, хранящий пользователя и сегменты, в которых он состоит (создание, изменение, удаление сегментов, а также добавление и удаление пользователей в сегмент).

## Оглавление

1. [Запуск сервиса](#Запуск-сервиса)
2. [Примеры запросов](#Примеры-запросов)
3. [Архитектура](#Архитектура)
4. [Функциональные требования](#Функциональные-требования)
5. [Трудности в дополнительных заданиях](#Трудности-в-дополнительных-заданиях)
                                                                                                

## Запуск сервиса (пока без полной контейнеризации)
1. Запустить докер с postgresql
```shell
 docker compose -f local/postgresql/docker-compose.yml up

```
2. Запустить приложение
```shell
 go run dynamic-user-segmentation/cmd
```

## Примеры запросов
### 1. Добавить новый сегмент
#### 1.1 Без автоматического распределения
```shell
curl -XPOST -H "Content-type: application/json" -d \
'{
  "slug": "AVITO_SALE_30"
}' \
'localhost:8082/api/public/v1/segments'
```
#### 1.2 С автоматическим распределением (пока не реализовано)
```shell
curl -XPOST -H "Content-type: application/json" -d \
 '{
  "slug": "AVITO_VOICE_MESSAGES",
  "percentage": 50,
  "is_auto": true
}' \
 'localhost:8082/api/public/v1/segments'
```

### 2. Удалить сегмент
```shell
curl -XDELETE 'localhost:8082/api/public/v1/segments/AVITO_VOICE_MESSAGES'
```

### 3. Добавление/удаление сегментов у пользователя
```shell
curl -XPUT -H "Content-type: application/json" -d \
 '{
  "segments_to_add": [{
    "slug": "AVITO_VOICE_MESSAGES",
    "ttl_in_seconds": 86400
  },
  {
    "segment_to_add": {
      "slug": "AVITO_SALE_30"
    }
  }],
  "slugs_to_delete": [
    "AVITO_SALE_50"
  ]
}' 'localhost:8082/api/public/v1/users/some_user_id/segments'
```

### 4. Получить активные сегменты пользователя
```shell
curl -XGET 'localhost:8082/api/public/v1/users/some_user_id/segments'
```

### 5. Получить ссылку на историю сегментирования за месяц
```shell
curl -XGET 'localhost:8082/api/public/v1/users/history/2023-09'
```

### 6. Получить csv file из ссылки
Вставить в браузер ссылку из ответа на запрос №5.
```
localhost:8082/api/public/v1/history/files/7b64cdd5-988c-4cae-b875-5a48bd2e070f.csv
```

## Архитектура
### Архитектура сервиса
![Alt-текст](./docs/архитектура.jpg "Орк")
### Структура БД
![Alt-текст](./docs/структура-бд.png "Орк")

## Функциональные требования
### 1. Создание сегмента - POST /api/public/v1/segments
Тело запроса:

|   | Название   | Формат | Кратность | Описание                                                   |
|---|------------|--------|-----------|------------------------------------------------------------|
| 1 | slug       | string | 1         | уникальное название нового сегмента                        |
| 2 | percentage | float  | 0-1       | процент пользователей, которому определится данный сегмент |
| 3 | is_auto    | bool   | 0-1       | флаг автоматической сегментации                            |

### 2. Удаление сегмента - DELETE /api/public/v1/segment/{slug}
Параметры пути:

|   | Название | Формат | Кратность | Описание                                |
|---|----------|--------|-----------|-----------------------------------------|
| 1 | segment  | string | 1         | уникальное название удаляемого сегмента |

### 3. Добавление пользователя в сегменты - PUT /api/public/v1/users/{user_id}/segments
Тело запроса:

|   | Название         | Формат            | Кратность | Описание                                                       |
|---|------------------|-------------------|-----------|----------------------------------------------------------------|
| 1 | slugs_to_delete  | List[string]      | 0-1       | список уникальных названий сегментов для удаления пользователю |
| 2 | segments_to_add  | List[slug_to_add] | 0-1       | список сегментов для добавления у пользователя                 |
| - | segment_to_add   | Object            | -         | сегмент для добавления                                         |
| - | -.slug           | string            | 0-1       | уникальное название сегмента для добавления пользователю       |
| - | -.ttl_in_seconds | int               | 0-1       | время действия сегмента у пользователя                         |

Параметры пути:

|   | Название | Формат | Кратность | Описание           localhost:8082/api/public/v1/users/some_user_id/segments |
|---|----------|--------|-----------|-----------------------------------------------------------------------------|
| 1 | user_id  | string | 1         | уникальный идентификатор пользователя                                       |

### 4. Получение активных сегментов пользователя - GET /api/public/v1/users/{user_id}/segments
Параметры пути:

|   | Название | Формат | Кратность | Описание                              |
|---|----------|--------|-----------|---------------------------------------|
| 1 | user_id  | string | 1         | уникальный идентификатор пользователя |

### 5. Получение истории сегментов за месяц пользователя - GET /api/public/v1/user/history/{year}-{month}
Параметры пути:

|   | Название | Формат | Кратность | Описание                                                         |
|---|----------|--------|-----------|------------------------------------------------------------------|
| 1 | year     | string | 1         | год периода по паттерну: "{год}-{месяц}" (год и месяц - числа)   |
| 2 | month    | string | 1         | месяц периода по паттерну: "{год}-{месяц}" (год и месяц - числа) | 

## Трудности в дополнительных заданиях
